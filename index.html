<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Macromill.fusen" />


	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
	<!-- Optional theme -->
	<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css">
	<link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

	<link rel="stylesheet" href="css/jquery.macromill.fusen.min.css">

	<!-- Latest compiled and minified CSS -->
	<script src="http://code.jquery.com/jquery-1.6.1.min.js"></script>
	<script src="http://code.jquery.com/ui/1.9.2/jquery-ui.min.js"></script>
	<!-- Latest compiled and minified JavaScript -->
	<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

	<script src="js/jquery.macromill.fusen.min.js"></script>

    <title>Macromill.fusen Demo</title>
</head>

<body>

<!-- HEADER -->
<div id="header_wrap" class="outer">
    <header class="inner">
      <a id="forkme_banner" href="https://github.com/ryoichiohkubo/macromill.fusen">View on GitHub</a>

      <h1 id="project_title">Macromill.fusen</h1>
      <h2 id="project_tagline">Demo Page</h2>

        <section id="downloads">
          <a class="zip_download_link" href="https://github.com/ryoichiohkubo/macromill.fusen/zipball/master">Download this project as a .zip file</a>
          <a class="tar_download_link" href="https://github.com/ryoichiohkubo/macromill.fusen/tarball/master">Download this project as a tar.gz file</a>
        </section>
    </header>
</div>



<!-- MAIN CONTENT -->
<div id="main_content_wrap" class="outer">
  <section id="main_content" class="inner">

<!-- Demo Area -->
<h2><a name="welcome-to-github-pages" class="anchor" href="#welcome-to-github-pages"><span class="octicon octicon-link"></span></a>Clic "new Fusen" Button to add Fusen.</h2>
<p>ボタンをクリックすると付箋を追加できます。
位置を移動し、サイズを変更し、タイトルとメモを編集することができます。
このデモでは Local Strage に付箋を保存しています。ページを再表示すると保存した付箋が再現されます。</p>

<div class="container">
	<p><button type="button" class="btn btn-lg btn-default" id="addFusen">new Fusen</button></p>
	<div id="fusenContainer" style="height:300px; width:100%;">
	</div>
</div>



<!-- Sample Code -->
<h2><a name="designer-templates" class="anchor" href="#designer-templates"><span class="octicon octicon-link"></span></a>Sample Code</h2>

<h4>Update Callback</h4>
<p>Local Strage から保存済みの付箋を全て読み出し、同じ serialNo の付箋を削除します。
続いて、引数 current を読み出した付箋リストに追加します。
最後に付箋のリストを Local Strage に保存します。</p>

<pre><code>var storeKey = "ADMINMENU_FUSEN";	//Local Storage Store Key
updateCallback = function (event, current) {
	//Get all data from Local Storage.
	var storedAll = $.parseJSON(window.localStorage.getItem(storeKey));
	if (storedAll == null) {
		storedAll = [];
	}
	//Remove the data of which same 'serialNo'.
	for (var i=0; i&lt;storedAll.length; i++) {
		if (storedAll[i].serialNo == current.serialNo) {
			storedAll.splice(i, 1);
		}
	}
	for (var i=0; i&lt;storedAll.length; i++) {
		storedAll[i].settings.memo = storedAll[i].settings.memo.replace(/\\/g, '\\\\').replace(/\"/g, '\\"');
	}
	
	//Add current settings to loaded deta.
	storedAll.push({"serialNo": current.serialNo ,"settings": current});

	//Save to Local Storage.
	window.localStorage.removeItem(storeKey);
	window.localStorage.setItem(storeKey, window.JSON.stringify(storedAll));

	return true;
}
</code></pre>


<h4>Remove Callback</h4>
<p>Local Strage から保存済みの付箋を全て読み出し、同じ serialNo の付箋を削除します。
付箋のリストを Local Strage に保存します。</p>

<pre><code>removeCallback = function(event, current) {
	//Get all data from Local Storage.
	var storedAll = $.parseJSON(window.localStorage.getItem(storeKey));
	if (storedAll == null) {
		storedAll = [];
	}
	//Remove the data of which same 'serialNo'.
	for (var i=0; i&lt;storedAll.length; i++) {
		if (storedAll[i].serialNo == current.serialNo) {
			storedAll.splice(i, 1);
		}
	}
	for (var i=0; i&lt;storedAll.length; i++) {
		storedAll[i].settings.memo = storedAll[i].settings.memo.replace(/\\/g, '\\\\').replace(/\"/g, '\\"');
	}
	//Save to Local Storage.
	window.localStorage.removeItem(storeKey);
	window.localStorage.setItem(storeKey, window.JSON.stringify(storedAll));

	return true;
}
</code></pre>


<h4>Set up "new Fusen" Button</h4>
<p>"new Fusen" Button を Click した時に付箋を追加するように設定します。</p>

<pre><code>$('#addFusen')
.bind('click',function(event){
	var _offset = $(this).offset();
	
	//Create Fusen.
	$('&lt;div>').macromillFusen({
		offset: _offset
		,resizeStop: updateCallback
		,dragStop: updateCallback
		,remove: removeCallback
		,edit: updateCallback
	});
})
.css({
	cursor: 'pointer'
})
</code></pre>


<h4>Data load from Local Strage</h4>
<p>Local Strage から保存済みの付箋を全て読み出して、それぞれ付箋に設定します。
位置、サイズ、メモ内容などは保存したものをそのまま使用します。callBack function だけマージします。</p>

<pre><code>//Get all data from Local Storage.
var storedAll = $.parseJSON(window.localStorage.getItem(storeKey));
if (storedAll == null) {
	return;
}

//Create Fusen to initial display.
for (var i=0; i&lt;storedAll.length; i++) {
	//set callback functions.
	var option = $.extend({
	}, storedAll[i].settings || {});
	option.resizeStop = updateCallback;
	option.dragStop = updateCallback;
	option.remove = removeCallback;
	option.edit = updateCallback;

	//create fusen. 
	$('&lt;div>').macromillFusen(option);
}
</code></pre>


  </section>
</div>


<!-- FOOTER  -->
<div id="footer_wrap" class="outer">
  <footer class="inner">
    <p class="copyright">Macromill.fusen maintained by <a href="https://github.com/ryoichiohkubo">ryoichiohkubo</a></p>
    <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
  </footer>
</div>




<script>
$(function(){
	/*
	 * callBack
	 */
	//Update function
	var storeKey = "ADMINMENU_FUSEN";	//Local Storage Store Key
	updateCallback = function (event, current) {

		if (typeof window.localStorage == 'undefined') {
			alert('localstrage disabled.');
			return;
		}

		//Get all data from Local Storage.
		var storedAll = $.parseJSON(window.localStorage.getItem(storeKey));
		if (storedAll == null) {
			storedAll = [];
		}
		
		//Remove the data of which same 'serialNo'.
		for (var i=0; i<storedAll.length; i++) {
			if (storedAll[i].serialNo == current.serialNo) {
				storedAll.splice(i, 1);
			}
		}
		
		//TODO Temporary.  $.parseJSON()すると「"、\」のエスケープが解除されて次回読み込みエラーになってしまうので。
		for (var i=0; i<storedAll.length; i++) {
			storedAll[i].settings.memo = storedAll[i].settings.memo.replace(/\\/g, '\\\\').replace(/\"/g, '\\"');
		}
		
		//Add current settings to loaded deta.
		storedAll.push({"serialNo": current.serialNo ,"settings": current});

		//Save to Local Storage.
		window.localStorage.removeItem(storeKey);
		window.localStorage.setItem(storeKey, window.JSON.stringify(storedAll));

		return true;
	}
	
	//Delete function
	removeCallback = function(event, current) {
		if (typeof window.localStorage == 'undefined') {
			alert('localstrage disabled.');
			return;
		}

		//Get all data from Local Storage.
		var storedAll = $.parseJSON(window.localStorage.getItem(storeKey));
		if (storedAll == null) {
			storedAll = [];
		}
		
		//Remove the data of which same 'serialNo'.
		for (var i=0; i<storedAll.length; i++) {
			if (storedAll[i].serialNo == current.serialNo) {
				storedAll.splice(i, 1);
			}
		}
		
		//TODO Temporary. $.parseJSON()すると「"、\」のエスケープが解除されて次回読み込みエラーになってしまうので。
		for (var i=0; i<storedAll.length; i++) {
			storedAll[i].settings.memo = storedAll[i].settings.memo.replace(/\\/g, '\\\\').replace(/\"/g, '\\"');
		}

		//Save to Local Storage.
		window.localStorage.removeItem(storeKey);
		window.localStorage.setItem(storeKey, window.JSON.stringify(storedAll));

		return true;
	}

	/*
	 * Set 'Fusen' button, and set up Click event.
	 */
	$('#addFusen')
	.bind('click',function(event){
		
		var _offset = $(this).offset();
		
		//Create Fusen.
		$('<div>').macromillFusen({
			offset: _offset
			,resizeStop: updateCallback
			,dragStop: updateCallback
			,remove: removeCallback
			,edit: updateCallback
		});
	})
	.css({
		cursor: 'pointer'
	})

	 
	/*
	 * Get all data from Local Storage, and create Fusen for initial display.
	 */
	if (typeof window.localStorage == 'undefined') {
		return;
	}
	
	//Get all data from Local Storage.
	var storedAll = $.parseJSON(window.localStorage.getItem(storeKey));
	if (storedAll == null) {
		return;
	}
	
	//Create Fusen to initial display.
	for (var i=0; i<storedAll.length; i++) {
		//set callback functions.
		var option = $.extend({
		}, storedAll[i].settings || {});
		option.resizeStop = updateCallback;
		option.dragStop = updateCallback;
		option.remove = removeCallback;
		option.edit = updateCallback;

		//create fusen. 
		$('<div>').macromillFusen(option);
	}
})
</script>

</body>
</html>
