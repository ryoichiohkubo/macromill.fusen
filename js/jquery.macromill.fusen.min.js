(function(a){a.fn.macromillFusen=function(b){return this.each(function(){var f=a.extend({serialNo:null,offset:null,size:null,backgroundColor:null,opacity:null,title:"",memo:"",parentId:null,parentOffset:null,containerId:null,resizeStop:null,dragStop:null,edit:null,remove:null},b||{});if(f.serialNo==null){var d=new Date();f.serialNo="parent="+f.parentId+":date="+d.getFullYear()+"-"+d.getMonth()+"-"+d.getDate()+"-"+d.getHours()+"-"+d.getMinutes()+"-"+d.getSeconds()+"-"+d.getMilliseconds()}var c=a("body");if(f.containerId!=null&&a("#"+f.containerId).size()>0){c=a("#"+f.containerId)}var h=a(this).addClass("macromill-fusen").resizable({ghost:true,autoHide:true,stop:function(n){if(f.resizeStop!=null){f.resizeStop(n,h._current())}}}).draggable({stop:function(n){if(f.dragStop!=null){f.dragStop(n,h._current())}}});var i=a("<div>").addClass("macromill-fusen-titlebar").prependTo(h);var g=a("<span>&nbsp;&#967;&nbsp;</span>").addClass("macromill-fusen-titlebar-remove").attr("role","button").click(function(n){h.draggable("destroy");h.resizable("destroy");if(f.remove!=null){f.remove(n,h._current())}h.remove()}).appendTo(i);var k=a("<span>").uniqueId().addClass("macromill-fusen-title").html(f.title).appendTo(i);var e=a("<div>").addClass("macromill-fusen-memo-box").appendTo(h);var j=a("<div>").addClass("macromill-fusen-memo").html(f.memo).appendTo(e);var m={top:"auto",left:"auto"};if((f.parentId!=null)&&a("#"+f.parentId).size()>0){var l=a("#"+f.parentId);m.top=l.offset().top;m.left=l.offset().left;if(f.parentOffset!=null){m.top=m.top+f.parentOffset.top;m.left=m.left+f.parentOffset.left}}else{if(f.offset!=null){m.top=f.offset.top;m.left=f.offset.left}}h.appendTo(c).offset({top:m.top,left:m.left});if(f.size!=null){h.height(f.size.height);h.width(f.size.width)}if(f.backgroundColor!=null){h.css("background-color",f.backgroundColor)}if(f.opacity!=null){h.css("opacity",f.opacity)}e.dblclick(function(){var t=a(this).parent(".macromill-fusen");var n=a(this).find(".macromill-fusen-memo");var r=n.html().replace(/(<BR>|<br>)/g,"\r").replace(/&nbsp;/g," ");n.html("");var s=t.find(".macromill-fusen-titlebar");var o=t.innerHeight()-s.outerHeight()-5*2;var p=t.innerWidth()-3*2;var q=a("<textarea></textarea>").text(r).addClass("macromill-fusen-edit").height(o).width(p).prependTo(a(this)).focus();q.blur(function(){var u=a(this).parent(".macromill-fusen-memo-box");var v=a(this).val().replace(/(\r|\n)/g,"<BR>").replace(/ /g,"&nbsp;");a(this).remove();u.find(".macromill-fusen-memo").html(v);if(f.edit!=null){f.edit(null,h._current())}})});i.dblclick(function(){var r=a(this).parent(".macromill-fusen");var q=a(this).find(".macromill-fusen-title");var n=q.html().replace(/(<BR>|<br>)/g,"\r").replace(/&nbsp;/g," ");q.html("");var o=a(this).innerHeight()-2;var p=a('<input type="text"></input>').addClass("macromill-fusen-title-edit").height(o).prependTo(a(this)).focus().val(n);p.blur(function(){var t=a(this).parent(".macromill-fusen-titlebar");var s=a(this).val().replace(/(\r|\n)/g,"").replace(/ /g,"&nbsp;");a(this).remove();t.find(".macromill-fusen-title").html(s);if(f.edit!=null){f.edit(null,h._current())}})});h._current=function(){var o=a.extend({},f||{});o.offset=h.offset();o.size={height:h.height(),width:h.width()};o.title=h.find(".macromill-fusen-title").text().replace(/\\/g,"\\\\").replace(/\"/g,'\\"');o.memo=(h.find(".macromill-fusen-memo").html()).replace(/\\/g,"\\\\").replace(/\"/g,'\\"');o.parentOffset=null;if((o.parentId!=null)&&a("#"+f.parentId).size()>0){var n=a("#"+f.parentId);o.parentOffset={top:h.offset().top-n.offset().top,left:h.offset().left-n.offset().left}}o.dragStop=null;o.remove=null;o.edit=null;return o};return this})}})(jQuery);